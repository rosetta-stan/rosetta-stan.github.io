---
title: "Stan Usage"
author: "Breck Baldwin"
date: "8/8/2020"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This document tracks Stan and Stan ecosystem usage over time. 

#CRAN downloads

```{r}
library(cranlogs)
library(ggplot2)
library(dplyr)
library(lubridate)
library(httr)
library(jsonlite)
library(stringr)
library(R.cache)
library(ggrepel)



packages <- c('rstan','rstanarm','shinystan','loo','bayesplot','rstantools')

dls <- cran_downloads(
  packages = packages, 
  from ="2015-06-01",
  to = "2020-07-31"
)

mls <- dls %>% mutate(month=floor_date(date,"monthly")) %>% 
  group_by(month,package)  %>% #?? order matters for month/package??
  summarize(monthly_downloads=sum(count))

# mls data check
 mls_val = (mls %>% filter(package=='rstanarm') %>%
            filter(month=='2018-02-01'))$monthly_downloads 
 
 dls_val = sum(cran_downloads(packages = c('rstanarm'), 
               from ="2018-02-01", to = "2018-02-28")$count)
 
 if (mls_val != dls_val) {
   stop(sprintf(paste("Problems with data, expect computed monthly total",        "mls_val=%d and more simply computed monthly total dls_val=%d to be equal"),
   mls_val, dls_val))
   }

plot1 <- ggplot() + geom_line(data=mls,
                  aes(x=month, y=monthly_downloads, color=package))

log_plot1 <- plot1 + scale_y_continuous(breaks=c(0,150,1000,10000,70000), 
                     trans = scales::log_trans())

```
```{r message=FALSE, warning=FALSE}
print(plot1)
```


```{r message=FALSE, warning=FALSE}
print(log_plot1)
```

#Stan references at scholar.google.com. 

```{r}
library('httr')
library('jsonlite')
library('stringr')
library('R.cache')
library('tidyr')
library('ggplot2')

get_results <-function(url) {
  key <- list(url)
  data <- loadCache(key=key)
  if (!is.null(data)) {
    cat(paste("\nhitting cache for",url))
    return(data)
  }
  cat(paste("\ncache miss, querying:",url,"\n"))
  random_wait <- abs(rnorm(1,5,5))
  cat(paste("\nWaiting",random_wait,"seconds to be nice to webserver\n"))
  Sys.sleep(random_wait)
  result <- GET(url)
  saveCache(result,key=key)
  return(result)
}

query_builder <- function(and='', or='', not='', phrase='', loc='any', start='', end='') {
  url <- ''
  if (or == '' && not == '' && phrase=='' && loc=='any') { #simple query
    url <- paste("https://scholar.google.com/scholar?",
                 "q=",str_replace_all(and,'\\s+','+'),
                 "&hl=en&as_sdt=0%2C33&as_ylo=",start,
                 "&as_yhi=",end,sep="")
  } else { #advanced query
    url <- paste("https://scholar.google.com/scholar?as_q=",str_replace_all(and,'\\s+','+'),
                 "&as_epq=",str_replace_all(phrase,'\\s+','+'),
                 "&as_oq=",str_replace_all(or,'\\s+','+'),
                 "&as_eq=",str_replace_all(not,'\\s+','+'),
                 "&as_occt=",str_replace_all(loc,'\\s+','+'), #title/any for where to search
                 "&as_sauthors=",
                 "&as_publication=",
                 "&as_ylo=",start,
                 "&as_yhi=",end,
                 "&hl=en",
                 "&as_sdt=0%2C33", #  don't know what this element is
                 sep="")
  }
  return(url)
}


year_start <- 2012
year_end <- 2020
date_queried <- '2020-08-15'

# extrapolate to full year
day_count_current_year <- as.numeric(as.Date(date_queried) - as.Date('2020-01-01'))
extrapolation_partial_year = 365/day_count_current_year

# truncate 2020 to partial year 
end_date_in_decimal <- 2020 + day_count_current_year/365

years <- c(as.double(year_start:(year_end -1)),end_date_in_decimal)
df <- data.frame(years)
df_cumul <- data.frame(years)

pkg_query <- c('stan',        'rstan', 'rstanarm',
               'mc-stan.org', 'rstan', 'rstanarm',
               '','','')

#  pkg_query <- c('pymc3', 'pymc', 'rstan', 'pystan', 'pymc2', 'pymc4', 'pymc*',
#               'pymc3', 'pymc', 'rstan', 'pystan', 'pymc2', 'pymc4', '',
#               '', '', '', '' , '', '', 'pymc+pymc2+pymc3+pymc4')

#pkg_query <- c('pymc3', 'rstan', 'pystan', 'pymc*',
#               'pymc3', 'rstan', 'pystan', '',
#               '',      '',      '',       'pymc+pymc2+pymc3+pymc4')

pkg_query_m <- matrix(pkg_query,ncol=3)





for (i in 1:nrow(pkg_query_m) ) {
  package = pkg_query_m[i,1]
  and_query = pkg_query_m[i,2]
  or_query = pkg_query_m[i,3]
  year_counts = c()
  for (year in year_start:year_end) {
    url <- query_builder(and=and_query, or=or_query, start=year, end=year)
    result <- get_results(url) #  Cached get calls with waits
    result_text <- content(result,'text')
    count <- NA
    if (!is.na(str_match(result_text,"did not match any articles")[1,1])) {
      count = 0
    } else { # '2 results (0.02 sec)', 'About 3,454 results' match first instance of
      count_string = str_match(result_text,"(About )?([\\d,]+) result(s)?")[1,3]
      count = as.numeric(str_remove(count_string,","))
    }
    year_counts <- c(year_counts,count)
  }
  df[package] <- year_counts
  df_cumul[package] <- cumsum(year_counts)
}

# trim the scale on the graph to be correct for Aug 8 so we don't have to interpolate but only works for cumulative


df_long <- gather(df,package,yr_count,
                  pkg_query_m[1,1]:pkg_query_m[nrow(pkg_query_m),1])

df_long_label <- df_long %>% 
  mutate(label=if_else(years == max(years), 
                       as.character(package),NA_character_))

plot2 <- ggplot(data=df_long_label,aes(x=years,y=yr_count,group=package, color=package)) + 
  geom_line() +
  geom_label_repel(aes(label = label),
                   na.rm = TRUE) +
  scale_color_discrete(guide = FALSE)


log_plot2 <- plot2 + scale_y_continuous(breaks=c(0,2,20,150,1000),
                                        trans = scales::log_trans())

#  =====
start_col <- pkg_query_m[1,1]
end_col <- pkg_query_m[nrow(pkg_query_m),1]
df_cumul_long <- gather(df_cumul, key=package, value=yr_count_cumul, 
                        all_of(start_col):all_of(end_col))

df_cumul_long_label <- df_cumul_long %>% 
  mutate(label=if_else(years == max(years), 
                       as.character(package),NA_character_))

plot_cumlative <- ggplot(data=df_cumul_long_label,aes(x=years,y=yr_count_cumul,group=package, color=package)) + 
  geom_line() +
  geom_label_repel(aes(label = label),
                   na.rm = TRUE) +
  scale_color_discrete(guide = FALSE)

log_plot_cumulative <- plot_cumlative + scale_y_continuous(breaks=c(0,2,20,150,1000),
                                    trans = scales::log_trans())

```

```{r message=FALSE, warning=FALSE}
print(plot2)
```

```{r message=FALSE, warning=FALSE}
print(plot3_cumulative)
```